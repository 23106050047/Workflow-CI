name: CI MLflow - Diabetes Prediction

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

env:
  CSV_PATH: "MLProject/diabetes_prediction_dataset_preprocessing.csv"
  TARGET_VAR: "diabetes"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Check environment variables
        run: |
          echo "CSV_PATH=$CSV_PATH"
          echo "TARGET_VAR=$TARGET_VAR"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f MLProject/conda.yaml ]; then
            # Install dari conda.yaml dependencies
            pip install mlflow==2.19.0 scikit-learn==1.3.2 pandas==2.0.3 numpy==1.24.3 matplotlib==3.7.2 seaborn==0.12.2
          fi

      - name: Run MLflow project (local env)
        run: |
          cd MLProject
          mlflow run . --env-manager=local -P data_path=diabetes_prediction_dataset_preprocessing.csv

      - name: Get latest MLflow run_id
        run: |
          RUN_ID=$(ls -td MLProject/mlruns/0/*/ 2>/dev/null | head -n 1 | cut -d'/' -f4)
          if [ -z "$RUN_ID" ]; then
            echo "No run found, checking mlruns in root"
            RUN_ID=$(ls -td mlruns/0/*/ 2>/dev/null | head -n 1 | cut -d'/' -f3)
          fi
          if [ -z "$RUN_ID" ]; then
            echo "ERROR: No MLflow run found!"
            exit 1
          fi
          echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV
          echo "Latest run_id: $RUN_ID"

      - name: Build Docker Model
        env:
          RUN_ID: ${{ env.RUN_ID }}
        run: |
          if [ -z "$RUN_ID" ]; then 
            echo "No RUN_ID found, exiting"
            exit 1
          fi
          # Build docker dari model artifact
          cd MLProject
          if [ -d "mlruns/0/$RUN_ID/artifacts/model" ]; then
            MODEL_URI="runs:/$RUN_ID/model"
          else
            cd ..
            MODEL_URI="runs:/$RUN_ID/model"
          fi
          echo "Building Docker with MODEL_URI: $MODEL_URI"
          mlflow models build-docker --model-uri "$MODEL_URI" --name "diabetes_prediction_classification"

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Tag Docker Image
        run: |
          docker tag diabetes_prediction_classification ${{ secrets.DOCKER_HUB_USERNAME }}/diabetes_prediction_classification:latest

      - name: Push Docker Image
        run: |
          docker push ${{ secrets.DOCKER_HUB_USERNAME }}/diabetes_prediction_classification:latest
          echo "Docker image pushed successfully!"
          echo "Image: ${{ secrets.DOCKER_HUB_USERNAME }}/diabetes_prediction_classification:latest"

      - name: Save Docker Hub link
        run: |
          mkdir -p MLProject
          echo "https://hub.docker.com/r/${{ secrets.DOCKER_HUB_USERNAME }}/diabetes_prediction_classification" > MLProject/DOCKER_HUB_LINK.txt
          cat MLProject/DOCKER_HUB_LINK.txt

      - name: Upload ML artifacts as workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: ml-artifacts
          path: |
            mlruns
            MLProject/mlruns
            MLProject/cm

      - name: Commit and push CI artifacts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # Add artifacts
          git add MLProject/cm/*.png MLProject/cm/*.json MLProject/cm/*.txt MLProject/DOCKER_HUB_LINK.txt 2>/dev/null || echo "No cm artifacts to add"
          
          # Commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ“¦ Add CI artifacts (confusion matrix, metrics, Docker link)"
            git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} HEAD:${{ github.ref_name }}
            echo "Artifacts committed and pushed successfully!"
          fi

      - name: Summary
        run: |
          echo "âœ… Training completed successfully!"
          echo "âœ… Docker image built and pushed to Docker Hub"
          echo "âœ… Artifacts saved to repository"
          echo ""
          echo "ğŸ“Š Check artifacts in: MLProject/cm/"
          echo "ğŸ³ Docker image: ${{ secrets.DOCKER_HUB_USERNAME }}/diabetes_prediction_classification:latest"
